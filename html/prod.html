<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Prod - Where did I waste my time today?</title>
    <!--[if IE]><script language="javascript" type="text/javascript" src="excanvas.min.js"></script><![endif]-->
    <script language="javascript" type="text/javascript" src="jquery.min.js"></script>
    <script language="javascript" type="text/javascript" src="jquery.flot.min.js"></script>
    <script language="javascript" type="text/javascript" src="jquery.flot.stack.min.js"></script>
    <script language="javascript" type="text/javascript" src="data.js"></script>
 </head>

 <body>
   <h1>Prod - Where did I waste my time today?</h1>
   <div id="placeholder" style="width:1280px;height:600px;"></div>

   <p class="toggleControls">
    <input class="stacking" type="button" value="Stacking">
    <input class="linesBars" type="button" value="Lines/Bars">
    <input class="legend" type="button" value="Legend">
   </p>

   <p id="choices">Show:</p>


<script id="source" language="javascript" type="text/javascript">
$(function () {
    // TODO fix max y when add/remove series

    // helper for returning the weekends in a period
    function weekendAreas(axes) {
	var markings = [];
	var d = new Date(axes.xaxis.min);
	// go to the first Saturday
	d.setUTCDate(d.getUTCDate() - ((d.getUTCDay() + 1) % 7))
	d.setUTCSeconds(0);
	d.setUTCMinutes(0);
	d.setUTCHours(0);
	var i = d.getTime();
	do {
	    // when we don't set yaxis, the rectangle automatically
	    // extends to infinity upwards and downwards
	    markings.push({ xaxis: { from: i, to: i + 2 * 24 * 60 * 60 * 1000 } });
	    i += 7 * 24 * 60 * 60 * 1000;
	} while (i < axes.xaxis.max);

	return markings;
    }

    function plot() {
	$.plot($("#placeholder"), data, options);
    }


    var data = [];

    var stack = null;
    var linesBars = true;
    var legend = true;

    var options = {
	xaxis: { mode: "time", timeformat: "%y/%m/%d %H:%M:%S"},
	grid: { markings: weekendAreas },
	series: {
	    stack: stack,
	    bars: { show: !linesBars, align: "left", barWidth: 15*60*1000 },
	    lines: { show: linesBars }
	},
	legend: {
	    show: legend,
	    position: "nw",
	    backgroundOpacity: 1
	}
    };


    /* setup series choice */
    // hard-code color indices to prevent them from shifting as
    // countries are turned on/off
    var i = 0;
    $.each(datasets, function(key, val) {
	val.color = i;
	++i;
    });

    // insert checkboxes
    var choiceContainer = $("#choices");
    $.each(datasets, function(key, val) {
	choiceContainer.append('<br/><input type="checkbox" name="' + key +
			       '" checked="checked" id="id' + key + '">' +
			       '<label for="id' + key + '">'
				+ val.label + '</label>');
    });
    choiceContainer.find("input").click(plotAccordingToChoices);


    function plotAccordingToChoices() {
	data = [];
	choiceContainer.find("input:checked").each(function () {
	    var key = $(this).attr("name");
	    if (key && datasets[key])
		data.push(datasets[key]);
	});

	plot();
    }
    plotAccordingToChoices();


    /* setup bar/lines stack/nostack */
    function plotWithOptions() {
	options["series"]["stack"] = stack;
	options["series"]["bars"]["show"] = bars;
	options["series"]["lines"]["show"] = lines;
	plot();
    }

    $(".toggleControls input.stacking").click(function (e) {
	e.preventDefault();
	// toggle value
	stack = stack ? null: true;
	options["series"]["stack"] = stack;
	plot();
    });
    $(".toggleControls input.linesBars").click(function (e) {
	e.preventDefault();
	// toggle value
	linesBars = !linesBars;
	options["series"]["lines"]["show"] = linesBars;
	options["series"]["bars"]["show"] = !linesBars;
	plot();
    });

    /* setup legend controls */
    $(".toggleControls input.legend").click(function (e) {
	e.preventDefault();
	// toggle value
	legend = !legend;
	options["legend"]["show"] = legend;
	plot();
    });
});
</script>


 </body>
</html>
